# Standardç¨‹åºé‡æŠ•å½±å¯è§†åŒ–åŠŸèƒ½è¯´æ˜
# Reprojection Visualization in Standard Program

**æ—¥æœŸ**: 2025-12-09
**ä¿®æ”¹æ–‡ä»¶**: `src/standard.cpp`
**åŠŸèƒ½**: æ·»åŠ ç±»ä¼¼auto_aim_debug_mpcçš„å®æ—¶é‡æŠ•å½±å¯è§†åŒ–

---

## âœ… å®Œæˆå†…å®¹

### ä¿®æ”¹çš„æ–‡ä»¶

**`src/standard.cpp`** (Lines 81-107)

### æ–°å¢åŠŸèƒ½

#### 1. é‡æŠ•å½±å¯è§†åŒ–

åœ¨ä¸»å¾ªç¯ä¸­æ·»åŠ äº†å®æ—¶çš„è£…ç”²æ¿é‡æŠ•å½±æ˜¾ç¤ºï¼š

```cpp
/// é‡æŠ•å½±å¯è§†åŒ– (ç±»ä¼¼auto_aim_debug_mpc)
if (!targets.empty()) {
  auto target = targets.front();

  // ç»˜åˆ¶æ‰€æœ‰è£…ç”²æ¿ï¼ˆç»¿è‰²ï¼‰
  std::vector<Eigen::Vector4d> armor_xyza_list = target.armor_xyza_list();
  for (const Eigen::Vector4d & xyza : armor_xyza_list) {
    auto image_points =
      solver.reproject_armor(xyza.head(3), xyza[3], target.armor_type, target.name);
    tools::draw_points(img, image_points, {0, 255, 0});
  }

  // ç»˜åˆ¶ç„å‡†ç‚¹ï¼ˆçº¢è‰²ï¼‰
  if (command.control && aimer.debug_aim_point.valid) {
    Eigen::Vector4d aim_xyza = aimer.debug_aim_point.xyza;
    auto image_points =
      solver.reproject_armor(aim_xyza.head(3), aim_xyza[3], target.armor_type, target.name);
    tools::draw_points(img, image_points, {0, 0, 255});
  }
}
```

#### 2. å›¾åƒç¼©æ”¾æ˜¾ç¤º

æ˜¾ç¤ºæ—¶å°†å›¾åƒç¼©å°åˆ°50%ï¼Œå‡å°‘ç•Œé¢å ç”¨ï¼š

```cpp
// ç¼©å°å›¾åƒå¹¶æ˜¾ç¤º
cv::Mat img_display;
cv::resize(img, img_display, {}, 0.5, 0.5);
cv::imshow("reprojection", img_display);
int key = cv::waitKey(1);
if (key == 'q') break;
```

---

## ğŸ¨ å¯è§†åŒ–æ•ˆæœ

### æ˜¾ç¤ºå†…å®¹

| å…ƒç´  | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| **è£…ç”²æ¿å¤–æ¡†** | ç»¿è‰² | æ‰€æœ‰è¢«è·Ÿè¸ªçš„è£…ç”²æ¿ä½ç½® |
| **ç„å‡†ç‚¹** | çº¢è‰² | å½“å‰ç„å‡†çš„è£…ç”²æ¿ï¼ˆä»…åœ¨æœ‰æ§åˆ¶æ—¶æ˜¾ç¤ºï¼‰ |

### çª—å£ä¿¡æ¯

- **çª—å£åç§°**: `reprojection`
- **æ˜¾ç¤ºå°ºå¯¸**: åŸå§‹å›¾åƒçš„50% (960Ã—600ï¼Œå¦‚æœåŸå›¾æ˜¯1920Ã—1200)
- **é€€å‡ºæ–¹å¼**: æŒ‰ `q` é”®é€€å‡ºç¨‹åº

---

## ğŸ” åŠŸèƒ½è¯´æ˜

### 1. è£…ç”²æ¿é‡æŠ•å½±ï¼ˆç»¿è‰²ï¼‰

æ˜¾ç¤ºæ‰€æœ‰è¢«EKFè·Ÿè¸ªçš„è£…ç”²æ¿ï¼š
```cpp
std::vector<Eigen::Vector4d> armor_xyza_list = target.armor_xyza_list();
```

**armor_xyza**:
- `xyza[0..2]`: è£…ç”²æ¿ä¸­å¿ƒåœ¨ä¸–ç•Œåæ ‡ç³»çš„3Dä½ç½® (x, y, z)
- `xyza[3]`: è£…ç”²æ¿yawè§’åº¦ï¼ˆæœå‘ï¼‰

**ç”¨é€”**:
- éªŒè¯EKFä¼°è®¡çš„æ‰€æœ‰è£…ç”²æ¿ä½ç½®æ˜¯å¦å‡†ç¡®
- è§‚å¯Ÿç›®æ ‡çš„æ—‹è½¬è¿åŠ¨
- è°ƒè¯•è·Ÿè¸ªå™¨

### 2. ç„å‡†ç‚¹é‡æŠ•å½±ï¼ˆçº¢è‰²ï¼‰

æ˜¾ç¤ºAimeré€‰æ‹©çš„ç„å‡†è£…ç”²æ¿ï¼š
```cpp
if (command.control && aimer.debug_aim_point.valid) {
  Eigen::Vector4d aim_xyza = aimer.debug_aim_point.xyza;
  // ...
}
```

**æ˜¾ç¤ºæ¡ä»¶**:
- `command.control == true`: è‡ªç„æ§åˆ¶å·²æ¿€æ´»
- `aimer.debug_aim_point.valid == true`: ç„å‡†ç‚¹æœ‰æ•ˆ

**ç”¨é€”**:
- éªŒè¯ç„å‡†å™¨é€‰æ‹©çš„è£…ç”²æ¿æ˜¯å¦æ­£ç¡®
- è§‚å¯Ÿå¼¹é“é¢„æµ‹å’Œæå‰é‡
- è°ƒè¯•å°„å‡»é€»è¾‘

### 3. é‡æŠ•å½±åŸç†

```
3Dä¸–ç•Œåæ ‡ â†’ ç›¸æœºåæ ‡ç³» â†’ å›¾åƒå¹³é¢
    â†“              â†“             â†“
  xyza        R_camera       image_points
            t_camera
           camera_matrix
```

**solver.reproject_armor()**:
1. æ ¹æ®è£…ç”²æ¿ç±»å‹å’Œåç§°è·å–3Dæ¨¡å‹ç‚¹
2. ä»ä¸–ç•Œåæ ‡ç³»è½¬æ¢åˆ°ç›¸æœºåæ ‡ç³»
3. ä½¿ç”¨ç›¸æœºå†…å‚æŠ•å½±åˆ°å›¾åƒå¹³é¢
4. è€ƒè™‘ç•¸å˜çŸ«æ­£

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### è°ƒè¯•åœºæ™¯

#### 1. éªŒè¯æ ‡å®šç²¾åº¦
**è§‚å¯Ÿ**: ç»¿è‰²æ¡†æ˜¯å¦ä¸å®é™…è£…ç”²æ¿å¯¹é½
- âœ… å®Œå…¨å¯¹é½ â†’ æ ‡å®šæ­£ç¡®
- âŒ æœ‰åç§» â†’ æ£€æŸ¥ç›¸æœºæ ‡å®šã€æ‰‹çœ¼æ ‡å®š

#### 2. éªŒè¯è·Ÿè¸ªç²¾åº¦
**è§‚å¯Ÿ**: è£…ç”²æ¿æ—‹è½¬æ—¶ï¼Œç»¿è‰²æ¡†æ˜¯å¦è·Ÿéš
- âœ… å¹³æ»‘è·Ÿéš â†’ EKFå·¥ä½œæ­£å¸¸
- âŒ æŠ–åŠ¨/å»¶è¿Ÿ â†’ EKFå‚æ•°éœ€è¦è°ƒæ•´

#### 3. éªŒè¯ç„å‡†é€‰æ‹©
**è§‚å¯Ÿ**: çº¢è‰²æ¡†é€‰æ‹©çš„è£…ç”²æ¿
- åº”è¯¥é€‰æ‹©**å³å°†å‡ºç°**æˆ–**æœ€ä¼˜å°„å‡»ä½ç½®**çš„è£…ç”²æ¿
- ä¸åº”é€‰æ‹©**å³å°†æ¶ˆå¤±**çš„è£…ç”²æ¿

#### 4. éªŒè¯å¼¹é“é¢„æµ‹
**è§‚å¯Ÿ**: çº¢è‰²æ¡†ä¸ç»¿è‰²æ¡†çš„ç›¸å¯¹ä½ç½®
- çº¢è‰²æ¡†åº”è¯¥åœ¨ç›®æ ‡**è¿åŠ¨æ–¹å‘å‰æ–¹**ï¼ˆæå‰é‡ï¼‰
- è·ç¦»è¶Šè¿œï¼Œæå‰é‡è¶Šå¤§

---

## ğŸ”§ ä¸auto_aim_debug_mpcçš„å¯¹æ¯”

| ç‰¹æ€§ | standard.cpp | auto_aim_debug_mpc.cpp |
|------|--------------|----------------------|
| **é€šä¿¡æ–¹å¼** | CBoard (CAN/ä¸²å£) | Gimbal (ç›´è¿äº‘å°) |
| **æ§åˆ¶æ¨¡å—** | Aimer (ä¼ ç»Ÿæ§åˆ¶) | Planner (MPCæ§åˆ¶) |
| **ç»˜åˆ¶å†…å®¹** | è£…ç”²æ¿ + ç„å‡†ç‚¹ | è£…ç”²æ¿ + è§„åˆ’ç‚¹ |
| **ç„å‡†ç‚¹æ¥æº** | `aimer.debug_aim_point` | `planner.debug_xyza` |
| **æ˜¾ç¤ºçª—å£** | `reprojection` | `reprojection` |
| **ç¼©æ”¾æ¯”ä¾‹** | 0.5Ã— | 0.5Ã— |

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

```
ä¿®æ”¹æ–‡ä»¶: src/standard.cpp
æ–°å¢è¡Œæ•°: +27 è¡Œ
åˆ é™¤è¡Œæ•°: -3 è¡Œ
å‡€å¢åŠ : +24 è¡Œ

ä¿®æ”¹ä½ç½®: Lines 81-107
åŠŸèƒ½æ¨¡å—: å¯è§†åŒ–
```

---

## âš™ï¸ é…ç½®é¡¹

æ— éœ€é¢å¤–é…ç½®ï¼Œä½¿ç”¨ç°æœ‰é…ç½®æ–‡ä»¶å³å¯ã€‚

å¦‚æœéœ€è¦è°ƒæ•´æ˜¾ç¤ºå°ºå¯¸ï¼š
```cpp
// ä¿®æ”¹ç¼©æ”¾æ¯”ä¾‹
cv::resize(img, img_display, {}, 0.5, 0.5);  // å½“å‰50%
// æ”¹ä¸ºï¼š
cv::resize(img, img_display, {}, 0.3, 0.3);  // 30%
cv::resize(img, img_display, {}, 0.7, 0.7);  // 70%
cv::resize(img, img_display, {}, 1.0, 1.0);  // 100% (åŸå§‹å¤§å°)
```

---

## ğŸš€ è¿è¡Œç¨‹åº

### å¯åŠ¨

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
./build/standard

# æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶
./build/standard configs/camera.yaml
```

### é¢„æœŸè¾“å‡º

**ç»ˆç«¯æ—¥å¿—**:
```
[info] [CBoard] Using NEW CAN protocol
[info] [CBoard] New CAN IDs: quat=0x150, status=0x160, cmd=0x170
[info] [Cboard] Waiting for q...
[info] [Cboard] Opened.
[info] [NewCAN] Startup frame sent! NucStartFlag=1...
[info] Switch to auto_aim
```

**å›¾åƒçª—å£**:
- çª—å£åç§°: `reprojection`
- æ˜¾ç¤ºå†…å®¹: åŸå§‹å›¾åƒ + ç»¿è‰²è£…ç”²æ¿æ¡† + çº¢è‰²ç„å‡†ç‚¹
- å°ºå¯¸: 960Ã—600 (åŸå›¾1920Ã—1200çš„50%)

### é€€å‡º

æŒ‰ `q` é”®é€€å‡ºç¨‹åºã€‚

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: çª—å£ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
- OpenCV GUIåç«¯æœªå®‰è£…
- SSHè¿œç¨‹è¿è¡Œï¼ˆæ— X11è½¬å‘ï¼‰

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥OpenCVç‰ˆæœ¬
pkg-config --modversion opencv4

# æœ¬åœ°è¿è¡Œï¼ˆä¸è¦SSHï¼‰
# æˆ–å¯ç”¨X11è½¬å‘ï¼š
ssh -X user@host
```

### é—®é¢˜2: ç»¿è‰²æ¡†ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
- æ²¡æœ‰æ£€æµ‹åˆ°ç›®æ ‡
- Trackeræœªè¿›å…¥trackingçŠ¶æ€

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥YOLOæ˜¯å¦æ­£å¸¸æ£€æµ‹
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„trackerçŠ¶æ€

### é—®é¢˜3: çº¢è‰²æ¡†ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
- `command.control == false` (æœªè¿›å…¥æ§åˆ¶æ¨¡å¼)
- `aimer.debug_aim_point.valid == false` (ç„å‡†ç‚¹æ— æ•ˆ)
- ç”µæ§æœªåˆ‡æ¢åˆ°auto_aimæ¨¡å¼

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ç”µæ§æ¨¡å¼åˆ‡æ¢
- æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ä¸­çš„ "Switch to auto_aim"

### é—®é¢˜4: é‡æŠ•å½±ä¸å‡†ç¡®

**å¯èƒ½åŸå› **:
- ç›¸æœºæ ‡å®šå‚æ•°ä¸å‡†
- æ‰‹çœ¼æ ‡å®šå‚æ•°ä¸å‡†
- IMUæ•°æ®æœ‰è¯¯

**è§£å†³æ–¹æ³•**:
- é‡æ–°è¿›è¡Œç›¸æœºæ ‡å®š
- é‡æ–°è¿›è¡Œæ‰‹çœ¼æ ‡å®š
- æ£€æŸ¥CAN/ä¸²å£é€šä¿¡æ˜¯å¦æ­£å¸¸

---

## ğŸ“ æ‰©å±•åŠŸèƒ½å»ºè®®

### 1. æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯

```cpp
// æ˜¾ç¤ºè·ç¦»ä¿¡æ¯
cv::putText(img_display,
  fmt::format("Distance: {:.2f}m", target.distance()),
  cv::Point(10, 30), cv::FONT_HERSHEY_SIMPLEX, 0.7, {255, 255, 0}, 2);

// æ˜¾ç¤ºè§’é€Ÿåº¦
cv::putText(img_display,
  fmt::format("Omega: {:.2f}rad/s", target.ekf_x()[7]),
  cv::Point(10, 60), cv::FONT_HERSHEY_SIMPLEX, 0.7, {255, 255, 0}, 2);
```

### 2. ä¿å­˜å½•åƒ

```cpp
// åˆå§‹åŒ–VideoWriter
cv::VideoWriter writer("output.avi",
  cv::VideoWriter::fourcc('M','J','P','G'),
  30, cv::Size(960, 600));

// åœ¨ä¸»å¾ªç¯ä¸­ä¿å­˜å¸§
writer.write(img_display);
```

### 3. æ·»åŠ é”®ç›˜æ§åˆ¶

```cpp
int key = cv::waitKey(1);
if (key == 'q') break;
if (key == 's') {
  // ä¿å­˜å½“å‰å¸§
  cv::imwrite("screenshot.jpg", img_display);
  tools::logger()->info("Screenshot saved");
}
if (key == 'r') {
  // å¼€å§‹/åœæ­¢å½•åˆ¶
  recording = !recording;
}
```

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| v1.0 | 2025-12-09 | åˆå§‹ç‰ˆæœ¬ï¼Œæ·»åŠ é‡æŠ•å½±å¯è§†åŒ– |

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- `docs/NEW_CAN_PROTOCOL.md` - æ–°CANåè®®è¯´æ˜
- `docs/TIMESTAMP_SYNC_ANALYSIS.md` - æ—¶é—´æˆ³åŒæ­¥åˆ†æ
- `docs/AUTO_AIM_DEBUG_MPC_INTEGRATION.md` - MPCç¨‹åºæ¥å…¥åˆ†æ

---

**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ
**è¿è¡ŒçŠ¶æ€**: â³ å¾…å®æµ‹éªŒè¯
